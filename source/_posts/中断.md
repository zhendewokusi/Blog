---
title: 中断
date: 2024-02-07 22:13:33
tags: [真相还原]
---

## 中断种类
### 1. 外部中断

外部中断又可以细分为可屏蔽中断和不可屏蔽中断。
### 2. 内部中断

内部中断可以分为**软中断**和**异常**。
软中断是由软件主动发起的中断，并不是发生了某种错误。


## 中断描述符表

中断描述符表(Interrupt Descriptor Table,IDT)是保护模式下用于存储中断处理程序入口的表。

中断向量表和中断描述符表的区别？

- 中断描述符表地址不限制,在哪里都可以。
- 中断描述符表中的每个描述符用 8 字节描述。

## 中断处理过程以及保护

一个完整的中断包含CPU内部的CPU外部和CPU内部两个部分以及特权级的检查。

CPU 外:外部设备的中断由中断代理芯片接收,处理后将该中断的中断向量号发送到 CPU。
CPU 内:CPU 执行该中断向量号对应的中断处理程序。

这里只讨论CPU内部的过程：

1. 处理器根据中断向量号定位中断门描述符。
2. 处理器进行特权级检查。当前的特权级CPL必须在门描述符DPL和门中代码段描述符DPL之间（防止用户主动调用只为内核服务的例程）。

   1. 如果是由软中断 int n、int3 和 into 引发的中断,这些是用户进程中主动发起的中断,由用户代码控制,处理器要检查当前特权级 CPL 和门描述符 DPL,这是检查进门的特权下限,如果 CPL 权限大于等于 DPL,即数值上 CPL≤门描述符 DPL,特权级“门槛”检查通过,进入下一步的“门框”检查。否则,处理器抛出异常。
   2. 这一步检查特权级的上限(门框):处理器要检查当前特权级 CPL 和门描述符中所记录的选择子对应的目标代码段 DPL,如果 CPL 权限小于目标代码段 DPL,即数值上 CPL>目标代码段 DPL,检查通过。否则 CPL 若大于等于目标代码段 DPL,处理器将引发异常,也就是说,除了用返回指令从高特权级返回,特权转移只能发生在由低向高。
   3. 若中断是由外部设备和异常引起的,只直接检查 CPL 和目标代码段的 DPL,和上面的步骤2是一样的,要求 CPL 权限小于目标代码段 DPL,即数值上 CPL >目标代码段 DPL,否则处理器引发异常。

3. 执行中断处理程序。

IF 位只能限制外部设备的中断,对那些影响系统正常运行的中断都无效,如异常 exception,软中断,如 int n 等,不可屏蔽中断 NMI 都不受 IF 限制。